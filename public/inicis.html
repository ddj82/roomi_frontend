<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í¬íŠ¸ì› ê²°ì œ</title>
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
</head>
<body>
<div style="text-align: center; padding: 20px;">
    <h2>ê²°ì œ ì§„í–‰ ì¤‘...</h2>
    <div id="debug-info" style="text-align: left; padding: 10px; font-size: 12px; color: #666;"></div>
    <div id="error-message" style="color: red; display: none;"></div>
</div>

<script>
    function addDebugInfo(message) {
        const debugDiv = document.getElementById('debug-info');
        const timestamp = new Date().toLocaleTimeString();
        debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
        console.log(`[${timestamp}] ${message}`);
    }

    // ëª¨ë°”ì¼ í™˜ê²½ ê°ì§€
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
            window.innerWidth <= 768;
    }

    const urlParams = new URLSearchParams(window.location.search);
    const params = {
        orderId: urlParams.get('orderId') || `order_${Date.now()}`,
        amount: parseInt(urlParams.get('amount')) || 1000,
        buyerName: urlParams.get('buyerName') || "í™ê¸¸ë™",
        buyerEmail: urlParams.get('buyerEmail') || "test@example.com",
        buyerTel: urlParams.get('buyerTel') || "01012345678",
        buyerAddr: urlParams.get('buyerAddr') || "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬",
        redirectUrl: urlParams.get('redirectUrl') || "https://roomi.co.kr/success.html",
        channelKey: urlParams.get('channelKey') || "channel-key-14a7fa72-0d06-4bb5-9502-f721b189eb86",
        storeId: urlParams.get('storeId') || "store-7bb98274-0fb5-4b2e-8d60-d3bff2f3ca85"
    };

    window.onload = function () {
        const isMobileDevice = isMobile();
        addDebugInfo(`ğŸ“¦ PortOne v2 ê²°ì œ ìš”ì²­ ì‹œì‘ (ëª¨ë°”ì¼: ${isMobileDevice})`);

        const paymentRequest = {
            storeId: params.storeId,
            paymentId: params.orderId,
            channelKey: params.channelKey,
            payMethod: 'CARD',
            orderName: "í…ŒìŠ¤íŠ¸ ê²°ì œ ìƒí’ˆ",
            totalAmount: params.amount,
            currency: "KRW",
            customer: {
                customerId: params.buyerTel,
                fullName: params.buyerName,
                phoneNumber: params.buyerTel,
                email: params.buyerEmail,
                address: {
                    addressLine1: params.buyerAddr,
                    addressLine2: "",
                    country: "KR"
                }
            },
            redirectUrl: params.redirectUrl,
            m_redirect_url: params.redirectUrl, // ëª¨ë°”ì¼ ë¦¬ë‹¤ì´ë ‰íŠ¸ URL
            customData: {
                isMobile: true,
                userAgent: navigator.userAgent
            },
            popup : false // ëª¨ë°”ì¼ì¸ ê²½ìš° í˜„ì¬ ì°½ì—ì„œ ì—´ë„ë¡ ì„¤ì •
        };

        // ëª¨ë°”ì¼ì¸ ê²½ìš° ì¶”ê°€ ì„¤ì •
        if (isMobileDevice) {
            paymentRequest.m_redirect_url = params.redirectUrl;
            // ëª¨ë°”ì¼ì—ì„œëŠ” ìƒˆì°½ì´ ì•„ë‹Œ í˜„ì¬ì°½ì—ì„œ ê²°ì œ ì§„í–‰
            paymentRequest.popup = false;
            paymentRequest.display = {
                pc: 'popup',
                mobile: 'page'  // ëª¨ë°”ì¼ì—ì„œëŠ” í˜ì´ì§€ ë°©ì‹ìœ¼ë¡œ ê°•ì œ
            };
        }

        addDebugInfo('ê²°ì œ ìš”ì²­ ë°ì´í„°: ' + JSON.stringify(paymentRequest, null, 2));
        if (isMobileDevice) {
            //PortOne.setUserAgent("Mozilla/5.0 (iPhone; CPU iPhone OS 15_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148");
        }
        PortOne.requestPayment(paymentRequest)
            .then(result => {
                addDebugInfo("âœ… ê²°ì œ ì‘ë‹µ: " + JSON.stringify(result));

                // ê²°ì œ ìƒíƒœì— ë”°ë¥¸ ì²˜ë¦¬
                if (result.code === 0) {
                    // ê²°ì œ ì„±ê³µ
                    addDebugInfo("ê²°ì œ ì„±ê³µ!");
                    alert("ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.href = `${params.redirectUrl}?success=true&paymentKey=${result.paymentKey || result.imp_uid}`;
                } else {
                    // ê²°ì œ ì‹¤íŒ¨ ë˜ëŠ” ì·¨ì†Œ
                    addDebugInfo("ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ: " + result.error_msg);
                    alert(`ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤: ${result.error_msg || 'ì‚¬ìš©ì ì·¨ì†Œ'}`);

                    // ì·¨ì†Œ ì‹œ ì´ì „ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê±°ë‚˜ íŠ¹ì • í˜ì´ì§€ë¡œ ì´ë™
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        location.href = params.redirectUrl + "?success=false&reason=cancelled";
                    }
                }
            })
            .catch(error => {
                addDebugInfo("ê²°ì œ ì—ëŸ¬: " + JSON.stringify(error));
                document.getElementById('error-message').textContent = `ê²°ì œ ì‹¤íŒ¨: ${error.message || 'Unknown error'}`;
                document.getElementById('error-message').style.display = 'block';

                // ë” ìì„¸í•œ ì—ëŸ¬ ì •ë³´ í‘œì‹œ
                if (error.details) {
                    addDebugInfo("ì—ëŸ¬ ìƒì„¸: " + JSON.stringify(error.details));
                }

                // ì—ëŸ¬ ë°œìƒ ì‹œ ì²˜ë¦¬
                setTimeout(() => {
                    if (confirm("ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        location.reload();
                    } else {
                        if (window.history.length > 1) {
                            window.history.back();
                        } else {
                            location.href = params.redirectUrl + "?success=false&reason=error";
                        }
                    }
                }, 3000);
            });
    };
</script>
</body>
</html>