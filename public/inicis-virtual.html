<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ìè¨Ìä∏Ïõê Í≤∞Ï†ú</title>
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
</head>
<body>
<div style="text-align: center; padding: 20px;">
    <h2>Í≤∞Ï†ú ÏßÑÌñâ Ï§ë...</h2>
    <div id="debug-info" style="text-align: left; padding: 10px; font-size: 12px; color: #666;"></div>
    <div id="error-message" style="color: red; display: none;"></div>
</div>

<script>
    function addDebugInfo(message) {
        const debugDiv = document.getElementById('debug-info');
        const timestamp = new Date().toLocaleTimeString();
        debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
        console.log(`[${timestamp}] ${message}`);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const params = {
        orderId: urlParams.get('orderId') || `order_${Date.now()}`,
        amount: parseInt(urlParams.get('amount')) || 1000,
        buyerName: urlParams.get('buyerName') || "ÌôçÍ∏∏Îèô",
        buyerEmail: urlParams.get('buyerEmail') || "test@example.com",
        buyerTel: urlParams.get('buyerTel') || "01012345678",
        buyerAddr: urlParams.get('buyerAddr') || "ÏÑúÏö∏ÌäπÎ≥ÑÏãú Í∞ïÎÇ®Íµ¨",
        redirectUrl: urlParams.get('redirectUrl') || "https://roomi.co.kr/success-virtual.html",
        channelKey: urlParams.get('channelKey') || "channel-key-14a7fa72-0d06-4bb5-9502-f721b189eb86",
        storeId: urlParams.get('storeId') || "store-7bb98274-0fb5-4b2e-8d60-d3bff2f3ca85"
    };
    const validUntil = new Date();
    validUntil.setMinutes(validUntil.getMinutes() + 29);
    window.onload = function () {
        addDebugInfo('üì¶ PortOne v2 Í≤∞Ï†ú ÏöîÏ≤≠ ÏãúÏûë');

        const paymentRequest = {
            storeId: params.storeId,
            paymentId: params.orderId,
            channelKey: params.channelKey,
            payMethod: 'VIRTUAL_ACCOUNT',
            orderName: "ÌÖåÏä§Ìä∏ Í≤∞Ï†ú ÏÉÅÌíà",
            totalAmount: params.amount,
            currency: "KRW",
            customer: {
                customerId: params.buyerTel,
                fullName: params.buyerName,
                phoneNumber: params.buyerTel,
                email: params.buyerEmail,
                address: {
                    addressLine1: params.buyerAddr,
                    addressLine2: "",
                    country: "KR"
                }
            },
            // ‚úÖ virtualAccount ÏÑ§Ï†ï ÏàòÏ†ï - accountExpiryÎ•º Ïò¨Î∞îÎ•∏ Í∞ùÏ≤¥ ÌòïÌÉúÎ°ú ÏÑ§Ï†ï
            virtualAccount: {
                bank: "KB",                           // Î∞úÍ∏â ÏùÄÌñâ
                accountExpiry: {
                    dueDate: validUntil   // Ïú†Ìö® Í∏∞Í∞ÑÏùÑ validUntilÎ°ú ÏÑ§Ï†ï
                },
                refundBank: "KB",                     // (ÏÑ†ÌÉù) ÌôòÎ∂àÏö©
                refundHolderName: "ÌôçÍ∏∏Îèô",           // (ÏÑ†ÌÉù) ÌôòÎ∂àÏö©
                refundAccount: "12345678901234"       // (ÏÑ†ÌÉù) ÌôòÎ∂àÏö©
            },
            redirectUrl: params.redirectUrl
        };

        addDebugInfo('Í≤∞Ï†ú ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞: ' + JSON.stringify(paymentRequest, null, 2));

        PortOne.requestPayment(paymentRequest)
            .then(async (response) => {
                console.log('=== PortOne Í≤∞Ï†ú ÏùëÎãµ ===');
                console.log(response);
                console.log('=== ÏùëÎãµ ÏÉÅÏÑ∏ ===');
                console.log('ÏÑ±Í≥µ Ïó¨Î∂Ä:', response.success);
                console.log('Í≤∞Ï†ú ID:', response.imp_uid);
                console.log('Ï£ºÎ¨∏ ID:', response.merchant_uid);
                if (response.success) {
                    console.log('=== Í∞ÄÏÉÅÍ≥ÑÏ¢å Ï†ïÎ≥¥ ===');
                    console.log('ÏùÄÌñâÎ™Ö:', response.vbank_name);
                    console.log('Í≥ÑÏ¢åÎ≤àÌò∏:', response.vbank_num);
                    console.log('ÏòàÍ∏àÏ£º:', response.vbank_holder);
                    console.log('ÏûÖÍ∏àÍ∏∞Ìïú:', response.vbank_date);
                    console.log('Ï†ÑÏ≤¥ ÏùëÎãµ Í∞ùÏ≤¥:', JSON.stringify(response, null, 2));
                } else {
                    console.log('Í≤∞Ï†ú Ïã§Ìå®:', response.error_msg);
                }
                const vaInfo = {
                    bank: result.virtualAccount?.bankName,
                    accountNumber: response.virtualAccount?.accountNumber,
                    holderName: response.virtualAccount?.holderName,
                    expiration: response.virtualAccount?.expiredAt,
                    paymentId: response.paymentId,
                    txId: result.txId
                };

                // ‚≠ê Í∞ÄÏÉÅÍ≥ÑÏ¢å Ï†ïÎ≥¥ localStorage Ï†ÄÏû•
                localStorage.setItem("virtualAccount", JSON.stringify(vaInfo));

                // ‚≠ê success-virtual.htmlÎ°ú Ïù¥Îèô
                window.location.href = `/success-virtual.html?paymentId=${vaInfo.paymentId}&txId=${vaInfo.txId}`;
            })
            .catch(error => {
                console.error("Í≤∞Ï†ú Ïã§Ìå®", error);
            });
    };
</script>
</body>
</html>