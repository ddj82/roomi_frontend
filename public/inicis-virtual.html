<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í¬íŠ¸ì› ê²°ì œ</title>
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
</head>
<body>
<div style="text-align: center; padding: 20px;">
    <h2>ê²°ì œ ì§„í–‰ ì¤‘...</h2>
    <div id="debug-info" style="text-align: left; padding: 10px; font-size: 12px; color: #666;"></div>
    <div id="error-message" style="color: red; display: none;"></div>
</div>

<script>
    function addDebugInfo(message) {
        const debugDiv = document.getElementById('debug-info');
        const timestamp = new Date().toLocaleTimeString();
        debugDiv.innerHTML += `[${timestamp}] ${message}<br>`;
        console.log(`[${timestamp}] ${message}`);
    }

    const urlParams = new URLSearchParams(window.location.search);
    const params = {
        orderId: urlParams.get('orderId') || `order_${Date.now()}`,
        amount: parseInt(urlParams.get('amount')) || 1000,
        buyerName: urlParams.get('buyerName') || "í™ê¸¸ë™",
        buyerEmail: urlParams.get('buyerEmail') || "test@example.com",
        buyerTel: urlParams.get('buyerTel') || "01012345678",
        buyerAddr: urlParams.get('buyerAddr') || "ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬",
        redirectUrl: urlParams.get('redirectUrl') || "com.myno1214.roomi://virtual",
        channelKey: urlParams.get('channelKey') || "channel-key-14a7fa72-0d06-4bb5-9502-f721b189eb86",
        storeId: urlParams.get('storeId') || "store-7bb98274-0fb5-4b2e-8d60-d3bff2f3ca85"
    };
    const validUntil = new Date();
    validUntil.setMinutes(validUntil.getMinutes() + 29);
    window.onload = function () {
        addDebugInfo('ğŸ“¦ PortOne v2 ê²°ì œ ìš”ì²­ ì‹œì‘');

        const paymentRequest = {
            storeId: params.storeId,
            paymentId: params.orderId,
            channelKey: params.channelKey,
            payMethod: 'VIRTUAL_ACCOUNT',
            orderName: "í…ŒìŠ¤íŠ¸ ê²°ì œ ìƒí’ˆ",
            totalAmount: params.amount,
            currency: "KRW",
            customer: {
                customerId: params.buyerTel,
                fullName: params.buyerName,
                phoneNumber: params.buyerTel,
                email: params.buyerEmail,
                address: {
                    addressLine1: params.buyerAddr,
                    addressLine2: "",
                    country: "KR"
                }
            },
            // âœ… virtualAccount ì„¤ì • ìˆ˜ì • - accountExpiryë¥¼ ì˜¬ë°”ë¥¸ ê°ì²´ í˜•íƒœë¡œ ì„¤ì •
            virtualAccount: {
                accountExpiry: {
                    dueDate: validUntil   // ìœ íš¨ ê¸°ê°„ì„ validUntilë¡œ ì„¤ì •
                },
            },
            redirectUrl: params.redirectUrl,
            m_redirect_url: params.redirectUrl, // ëª¨ë°”ì¼ ë¦¬ë‹¤ì´ë ‰íŠ¸ URL
        };

        addDebugInfo('ê²°ì œ ìš”ì²­ ë°ì´í„°: ' + JSON.stringify(paymentRequest, null, 2));

        PortOne.requestPayment(paymentRequest)
            .then(async (response) => {
                addDebugInfo('ê²°ì œ ì‘ë‹µ: ' + JSON.stringify(response, null, 2));

                // â­ response ê°ì²´ ì‚¬ìš© (vaInfo ì•„ë‹˜)
                if (response.code === 'FAILURE_TYPE_PG') {
                    addDebugInfo('âŒ ê²°ì œ ì‹¤íŒ¨: ' + response.message);
                    window.location.href = `/fail-virtual.html?message=${encodeURIComponent(response.message)}`;
                } else if (response.paymentId) {
                    addDebugInfo('âœ… ê°€ìƒê³„ì¢Œ ë°œê¸‰ ì„±ê³µ');
                    // response ê°ì²´ì—ì„œ í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
                    window.location.href = `/success-virtual.html?paymentId=${response.paymentId}&txId=${response.txId || ''}&bankCode=${response.virtualAccount?.bankCode || ''}&accountNumber=${response.virtualAccount?.accountNumber || ''}`;
                } else {
                    addDebugInfo('â“ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ');
                    window.location.href = `/fail-virtual.html?message=ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µì…ë‹ˆë‹¤`;
                }
            })
            .catch(error => {
                console.error("ê²°ì œ ì‹¤íŒ¨", error);
                addDebugInfo('âŒ ê²°ì œ ì—ëŸ¬: ' + error.message);

                const errorMessage = error.message || 'ê²°ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
                window.location.href = `/fail-virtual.html?message=${encodeURIComponent(errorMessage)}`;
            });
    };
</script>
</body>
</html>