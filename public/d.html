<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>결제 진행</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f5f5f5;
        }
        #status {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 80%;
        }
        #payButton {
            display: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div id="status">
    <div class="loader"></div>
    <p>결제를 준비하고 있습니다...</p>
</div>
<button id="payButton" onclick="requestPayment()">결제 시작</button>

<script>
    // URL에서 쿼리 파라미터 추출 함수
    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    // 토스페이먼츠 초기화
    const clientKey = "test_ck_ALnQvDd2VJ62j1xJBMWYVMj7X41m"; // 실제 사용 시 환경에 맞는 키로 변경해야 함
    const customerKey = getQueryParam('customerKey') || "FuASvtElaPrhsxwsQ73BT";
    const tossPayments = TossPayments(clientKey);
    const payment = tossPayments.payment({ customerKey });

    // 결제 요청 함수
    async function requestPayment() {
        try {
            document.getElementById("status").innerHTML = '<div class="loader"></div><p>결제를 요청하고 있습니다...</p>';

            // 필수 파라미터 확인
            const amount = getQueryParam('amount');
            const orderId = getQueryParam('orderId') || 'order_' + new Date().getTime();
            const orderName = getQueryParam('orderName') || '주문 상품';

            // 성공/실패 URL 설정
            const successUrl = getQueryParam('successUrl') || window.location.origin + "/success.html";
            const failUrl = getQueryParam('failUrl') || window.location.origin + "/fail.html";

            // 선택적 고객 정보
            const customerEmail = getQueryParam('customerEmail') || '';
            const customerName = getQueryParam('customerName') || '';
            const customerMobilePhone = getQueryParam('customerMobilePhone') || '';

            console.log("결제 요청 파라미터:", {
                amount, orderId, orderName, successUrl, failUrl,
                customerEmail, customerName, customerMobilePhone
            });

            // 결제 요청 옵션 구성
            const paymentOptions = {
                method: "CARD",
                amount: {
                    currency: "KRW",
                    value: parseInt(amount, 10) || 1000,
                },
                orderId: orderId,
                orderName: orderName,
                successUrl: successUrl,
                failUrl: failUrl,
                card: {
                    useEscrow: false,
                    flowMode: "DEFAULT",
                    useCardPoint: false,
                    useAppCardOnly: false,
                }
            };

            // 선택적 고객 정보 추가
            if (customerEmail) paymentOptions.customerEmail = customerEmail;
            if (customerName) paymentOptions.customerName = customerName;
            if (customerMobilePhone) paymentOptions.customerMobilePhone = customerMobilePhone;

            // 결제 요청
            await payment.requestPayment(paymentOptions);
        } catch (error) {
            console.error("결제 요청 오류:", error);
            document.getElementById("status").innerHTML = `
                    <p style="color: red;">결제 요청 중 오류가 발생했습니다.</p>
                    <p>${error.message || '알 수 없는 오류'}</p>
                `;
        }
    }

    // 페이지 로드 시 자동으로 결제 요청
    window.onload = function() {
        // 필수 파라미터 확인
        const amount = getQueryParam('amount');

        if (!amount) {
            document.getElementById("status").innerHTML = `
                    <p style="color: red;">필수 결제 정보가 없습니다.</p>
                    <p>결제 금액(amount)이 필요합니다.</p>
                `;
            return;
        }

        // 잠시 후 자동으로 결제 요청 (지연 추가)
        setTimeout(() => {
            let button = document.getElementById("payButton");
            button.click();
        }, 1000); // 1초 지연
    };
</script>
</body>
</html>